/* ========================================
 *
 * Copyright YOUR COMPANY, THE YEAR
 * All Rights Reserved
 * UNPUBLISHED, LICENSED SOFTWARE.
 *
 * CONFIDENTIAL AND PROPRIETARY INFORMATION
 * WHICH IS THE PROPERTY OF your company.
 *
 * ========================================
*/
#include "master.h"

 float32 red_data[1000] = {216239,214456,216624,215103,216897,215336,217504,215489,217328,215809,217351,215972,217336,216219,217287,216690,217162,216936,217031,217243,216941,217807,216776,217780,216802,218629,216823,218502,216937,218711,217025,219193,217142,218856,217315,218815,217304,218680,217503,218536,217768,218401,217943,218182,218243,217988,218651,217721,218625,217664,219325,217527,219134,217633,219400,217668,219827,217732,219447,217976,219770,217982,219496,218225,219465,218507,219317,218723,219137,219134,218999,219455,218624,219310,218200,219379,217212,218042,216079,217240,214860,216463,213960,215091,213161,214646,212489,213796,212137,213137,211995,212660,211893,212301,212054,212026,212341,211762,212424,211615,213129,211470,212969,211732,213555,211856,214065,212180,213907,212424,214553,212809,214484,213196,214661,213590,214668,213832,214724,214492,214684,214824,214619,215177,214536,215825,214428,215725,214614,216474,214745,216875,214965,216679,215202,217212,215275,217000,215475,216837,215443,216570,215457,216154,215603,215678,215588,215222,215480,214840,215776,214430,215419,214250,215953,213967,215819,213972,215644,213943,216049,213976,215773,214214,215670,214268,215567,214485,215484,214968,215341,215172,215225,215502,215091,216087,215004,216064,215120,216927,215081,216965,215383,217193,215606,217812,215776,217622,216093,217830,216378,217780,216661,217746,217165,217748,217652,217652,217794,217521,218410,217430,218400,217529,219228,217447,219196,217656,219379,217735,219955,217895,219690,218110,219846,218236,219607,218397,219546,218709,219315,218744,219099,219168,218922,219553,218688,219572,218567,220196,218447,219976,218530,220269,218551,220720,218717,220422,218842,220662,218956,220430,219094,220353,219339,220173,219482,219901,219884,219779,220204,219539,220299,219531,221102,219433,220943,219566,221264,219518,221617,219359,220741,218800,220128,217700,218594,216554,217227,215603,215892,214671,214842,214272,213891,213918,213169,213534,212660,213902,212127,213383,212035,213749,211858,214015,212005,213748,212192,214289,212414,214113,212801,214167,213091,214283,213497,214320,214079,214344,214501,214246,214862,214343,215656,214277,215640,214500,216354,214596,216632,214790,216577,215005,217177,215214,216984,215499,216953,215648,216855,215878,216802,216405,216650,216615,216320,216750,216142,217117,215649,216618,215452,217096,215049,216803,214900,216438,214756,216749,214576,216212,214624,216002,214547,215779,214561,215496,214895,215308,215022,214983,215258,214831,215782,214563,215643,214586,216434,214486,216308,214701,216455,214913,217104,215097,216889,215365,217044,215606,217024,215863,216955,216304,216909,216548,216732,216977,216708,217509,216610,217532,216673,218484,216633,218398,216834,218615,217032,219248,217235,218938,217466,219198,217513,219077,217753,218867,218051,218768,218234,218552,218523,218348,218873,218124,218872,218048,219635,217783,219350,217863,219581,217841,220030,217967,219601,218157,219999,218138,219682,218335,219595,218664,219488,218867,219309,219265,219130,219574,218898,219581,218781,220204,218537,219982,218611,220290,218598,220738,218693,220435,218914,220827,218968,220643,219265,220603,219507,220350,219391,219798,219276,218923,218624,217434,217447,216088,216773,214674,215497,213722,215102,212914,214765,212391,213729,212007,213789,211665,213196,211618,212846,211644,212666,211640,212360,211983,212207,212413,212080,212571,212103,213398,211981,213310,212184,214099,212363,214547,212734,214531,212978,215227,213346,215051,213635,215104,213856,215109,214102,214961,214574,214814,214783,214725,215158,214721,215773,214485,215677,214594,216402,214550,216359,214601,216206,214517,216493,214391,215951,214298,215630,214087,215199,213882,214741,214087,214261,213984,213882,214090,213560,214395,213125,214185,213088,214775,212831,214537,212927,214575,212975,215092,213140,214886,213267,214900,213403,214813,213639,214736,214089,214645,214349,214503,214735,214509,215256,214342,215318,214538,216312,214515,216331,214782,216596,215060,217257,215270,217033,215604,217276,215819,217263,216127,217311,216547,217192,216749,217099,217190,216915,217602,216792,217635,216816,218460,216649,218219,216760,218536,216877,218997,216946,218672,217115,218895,217154,218721,217385,218612,217656,218432,217764,218177,218117,217954,218436,217724,218430,217618,219231,217515,219013,217647,219332,217637,219911,217880,219633,218089,219996,218165,219716,218366,219667,218655,219516,218798,219377,219173,219274,219734,219116,219844,219134,220450,218810,219989,218374,219740,217380,218940,216209,217204,215140,216430,214060,215202,213297,214258,212695,213388,212213,212580,212185,212054,212023,211589,211960,211236,212443,210982,212171,210962,212766,211041,213124,211404,213101,211650,213762,211840,213558,212253,213669,212519,213730,212814,213724,213398,213690,213691,213464,213989,213465,214601,213270,214495,213450,215227,213418,215386,213632,215418,214044,216182,214306,216065,214597,216006,214604,215784,214784,215758,215193,215366,215112,214866,215034,214386,215249,213849,214792,213619,215225,213336,214991,213195,214833,213147,215234,213241,214993,213402,214855,213431,214694,213584,214578,213972,214456,214203,214250,214576,214213,215171,214086,215071,214165,215923,214187,215903,214354,216080,214577,216792,214822,216631,215210,216778,215403,216854,215704,216901,216290,216947,216622,216903,217169,216925,217741,216902,217790,217039,218676,217005,218703,217192,218894,217291,219501,217484,219257,217730,219444,217849,219262,218046,219101,218205,218929,218323,218613,218670,218475,219002,218232,218900,218033,219672,217850,219379,217933,219619,218011,220070,218060,219775,218268,220031,218341,219810,218464,219621,218700,219406,218794,219184,219139,219008,219445,218711,219414,218657,220186,218533,220027,218642,220299,218685,220673,218477,219915,218066,219439,217117,218054,216037,216710,215119,215425,214158,214199,213572,213157,213147,212224,212547,211614,212766,210945,212113,210768,212347,210565,212573,210556,212196,210701,212683,210825,212518,211157,212549,211521,212644,211898,212634,215050,212814,213023,212811,213455,212947,214284,212960,214280,213216,215079,213475,215546,213745,215518,214094,216211,214341,216138,214736,216252,215058,216242,215368,216239,215836,216028,216065,215644,215995,215322,216239,214807,215760,214465,216012,214035,215780,213855,215429,213634,215611,213514,215062,213460,214751,213310,214484,213360,214081,213541,213819,213741,213493,213791,213280,214324,213080,214129,213121,214857,213068,214904,213225,214942,213462,215603,213722,215527,213997,215563,214216,215548,214574,215616,215057,215558,215432,215491,215830,215417,216459,215378,216474,215542,217276,215599,217375,215868,217546,216051,218208,216328,218033,216567,218187,216702,218066,216942,217976,217311,217818,217525,217664,217792,217485,218281,217312,218243,217307,218943,217246,218816,217335,218970,217427,219620,217554,219324,217783,219389,217868,219254,218013,219097,218298,218930,218364,218581,218696,218439,219083,218217,218986,218121,219731,218066,219523,218073,219635};
 float32 ir_data[1000] = {110250,110708,110538,110625,110944,110516,111376,110334,111369,110486,112209,110464,112177,110640,112403,111981,112994,110991,112804,111250,112914,111371,112822,111593,112690,111927,112556,112175,112382,112526,112239,112899,111982,112857,111917,113566,111759,113407,111917,113586,111949,114136,112014,113699,112179,113961,112235,113760,112437,113597,112649,113413,112764,113185,113181,112997,113463,112708,113503,112659,114252,112465,113968,112584,114261,112530,114746,112658,114340,112859,114737,112931,114419,113136,114404,113402,114300,113562,114001,113784,113584,113666,112772,113011,111759,112748,110602,111530,109851,111148,109117,110975,108638,110105,108381,110115,108062,109552,107990,109199,107965,108886,108039,108556,108320,108388,108621,108174,108770,108150,109515,108032,109428,108221,110071,108317,110526,108589,110381,108821,110946,109073,110759,109388,110826,109619,110727,109832,110643,110346,110540,110622,110397,110813,110266,111409,110085,111269,110125,111969,110153,112123,110299,111981,110442,112403,110444,112105,110510,111901,110390,111536,110358,111152,110484,110668,110447,110280,110510,109974,110914,109535,110621,109508,111218,109291,111071,109362,110983,109436,111576,109456,111210,109611,111192,109704,111038,109871,110917,110265,110764,110560,110575,110809,110466,111351,110295,111267,110289,112120,110302,112069,110438,112241,110588,112875,110851,112564,111070,112778,111201,112686,111400,112613,111806,112452,111992,112262,112403,112158,112858,111977,112827,111912,113583,111770,113373,111869,113603,111879,114105,112021,113699,112192,113922,112233,113708,112393,113550,112636,113295,112658,113038,113011,112783,113337,112655,113342,112544,114092,112346,113886,112431,114192,112516,114648,112595,114307,112714,114621,112786,114296,112971,114194,113074,113976,113295,113750,113582,113597,113918,113349,114040,113295,114769,113161,114509,113101,114883,113031,115021,112670,113976,111992,113506,111149,112329,110509,111370,109827,110434,109283,109703,109123,108982,109040,108422,108817,107948,109124,107522,108754,107383,109171,107332,109447,107468,109145,107626,109701,107699,109441,108042,109496,108296,109386,108490,109307,109012,109291,109424,109179,109695,109115,110348,109027,110242,109146,110950,109110,111153,109291,110975,109373,111584,109583,111347,109850,111305,109974,111165,110098,110973,110459,110737,110562,110357,110620,109970,110860,109526,110496,109354,111011,109082,110799,108977,110567,108871,110956,108813,110494,108941,110387,108845,110143,108912,109912,109194,109642,109317,109380,109584,109191,110062,108930,109953,108958,110734,108873,110567,108993,110761,109199,111369,109405,111105,109609,111236,109814,111164,110016,111123,110464,111119,110682,110923,111155,110878,111594,110724,111610,110780,112521,110693,112324,110865,112644,111055,113196,111155,112857,111386,113097,111457,112902,111667,112804,111929,112561,112048,112403,112439,112251,112799,112008,112715,111886,113480,111662,113201,111806,113478,111800,113980,111898,113592,112000,113901,112144,113632,112302,113557,112533,113325,112666,113111,113068,113038,113431,112740,113465,112655,114184,112469,113897,112563,114306,112577,114820,112812,114463,112955,114958,113098,114675,113242,114432,113186,113859,112673,112877,112167,111688,111505,110573,110796,109606,110622,108762,109708,108246,109743,107701,109714,107503,109009,107385,109182,107188,108819,107251,108644,107415,108493,107520,108281,108045,108193,108401,108066,108590,108095,109287,107891,109177,108106,109891,108214,110212,108381,110036,108566,110665,108693,110419,108928,110377,109106,110225,109260,110136,109731,109990,110078,109858,110335,109822,110921,109637,110745,109634,111377,109566,111422,109584,111190,109437,111436,109344,110894,109249,110620,109135,110238,109042,109886,109288,109559,109367,109274,109536,109030,109940,108731,109764,108687,110433,108654,110398,108768,110374,108838,110986,108996,110692,109207,110781,109401,110741,109576,110552,109960,110511,110231,110317,110543,110250,111133,110159,111101,110239,111994,110288,112001,110505,112234,110715,112889,110914,112737,111194,112960,111391,112830,111682,112826,112034,112699,112268,112505,112576,112355,113006,112164,112891,112118,113735,111923,113456,112050,113710,112033,114226,112156,113785,112292,113980,112295,113677,112450,113523,112619,113387,112808,113171,113100,112976,113564,112719,113452,112627,114175,112435,113923,112508,114175,112541,114600,112596,114216,112677,114545,112767,114366,112980,114162,113176,114015,113278,113745,113587,113295,113556,112559,112923,111699,112677,110635,111593,109796,111055,109057,110836,108459,109870,108019,109676,107606,108994,107381,108513,107321,108070,107308,107754,107479,107518,107707,107184,107798,107124,108497,106997,108344,107143,108969,107238,109415,107572,109323,107868,109868,108047,109817,108446,109880,108796,109868,109025,109815,109618,109770,109929,109669,110265,109685,110923,109588,110880,109785,111538,109852,111841,109968,111628,109993,111991,109991,111642,109968,111235,109775,110842,109738,110380,109796,109995,109868,109548,109742,109074,110103,108736,109756,108549,110207,108365,110164,108395,110005,108389,110430,108462,110129,108597,110012,108663,109826,108803,109709,109226,109563,109449,109406,109737,109325,110375,109202,110290,109301,111041,109337,111189,109530,111181,109702,111904,109923,111696,110160,111730,110402,111694,110595,111666,111021,111516,111295,111363,111653,111303,112187,111108,112083,111114,112865,111136,112821,111250,112936,111313,113471,111409,113066,111597,113172,111643,113015,111833,112907,112196,112762,112375,112499,112599,112349,113129,112164,113031,112108,113744,111932,113534,112024,113656,112009,114210,112177,113816,112327,113962,112340,113752,112524,113575,112761,113390,112813,112964,112791,112305,112583,111355,111615,110311,111379,109190,110274,108357,109607,107587,109380,106995,108324,106572,108106,106188,107458,105971,106979,105879,106591,105796,106173,106073,105915,106318,105711,106380,105589,107086,105489,106915,105630,107294,105761,107942,106010,107695,106270,108169,106424,108004,106746,108034,107034,107957,107270,107768,107741,107738,108099,107585,108223,107512,108910,107431,108900,107582,109263,107634,109734,107637,109224,107729,109534,107588,109069,107579,108822,107516,108417,107402,107976,107590,107546,107682,107163,107634,106892,108059,106492,107730,106442,108097,106367,108381,106388,107969,106504,108453,106511,108188,106749,108108,106912,108006,107142,107878,107538,107733,107874,107578,108132,107630,108841,107481,108655,107599,109356,107647,109685,107872,109517,108116,110078,108171,109884,108470,109915,108599,109754,108834,109644,109201,109489,109458,109172,109569,109085,110136,108893,109959,108811,110519,108713,110614,108814,110401,108814,110858,108916,110567,109056,110425,109075,110288,109211,110098,109500,109836,109666,109650,109907,109457,110413,109245,110263,109189,110888,109118,110857,109297,110823,109318,111409,109434,111105,109597,111069,109719,110901,109763,110626,109898,110196,109684,109481,109307};


#define TEST_LENGTH_SAMPLES  1000
#define BLOCK_SIZE            1
#define NUM_TAPS              31

static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS - 1];

uint32_t blockSize = BLOCK_SIZE;
uint32_t numBlocks = TEST_LENGTH_SAMPLES/BLOCK_SIZE;


void filtre_2_75(float32 signal[], float32 signal_filtre[]){
    const float32_t firCoeffs32PasseBasBPM[NUM_TAPS] = {0.00381983760855944f,	0.00447764096944725f,	0.00618032248143428f,	0.00895951266892841f,	0.0127805771248028f,	0.0175417469528465f,	0.0230776721090104f,	0.0291672711633270f,	0.0355454488549002f,	0.0419179762526033f,	0.0479785976875530f,	0.0534272610605237f,	0.0579882763642388f,	0.0614271985818886f,	0.0635653068076209f,	0.0642907066246307f,	0.0635653068076209f,	0.0614271985818886f,	0.0579882763642388f,	0.0534272610605237f,	0.0479785976875530f,	0.0419179762526033f,	0.0355454488549002f,	0.0291672711633270f,	0.0230776721090104f,	0.0175417469528465f,	0.0127805771248028f,	0.00895951266892841f,	0.00618032248143428f,	0.00447764096944725f,	0.00381983760855944f};
      
    uint32_t i;
    arm_fir_instance_f32 S;
    float32_t *inputF32;
    float32_t *outputF32;

  
  inputF32 = &signal[0];
  outputF32 = &signal_filtre[0];
  /* Call FIR init function to initialize the instance structure. */
  arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32PasseBasBPM[0], &firStateF32[0], blockSize);
  /* ----------------------------------------------------------------------
  ** Call the FIR process function for every blockSize samples
  ** ------------------------------------------------------------------- */
  for(i=0; i < numBlocks; i++)
  {
    arm_fir_f32(&S, inputF32 + (i * blockSize), outputF32 + (i * blockSize), blockSize);
  } 
}


    float32 AC_valeur;
    float max_AC;
    uint32_t  indexmax_AC;
    float min_AC;
    uint32_t  indexmin_AC;
    int k;
    float AC_1000[1000] = {};

float32 AC(float32 signal[]){
    AC_valeur = 0;
    max_AC = 0;
    indexmax_AC = 0;
    min_AC = 0;
    indexmin_AC = 0;
    k = 0;
  
    
        for(int i=0; i<1000; i++){
            AC_1000[i] =signal[k];
            k++;
            }
        arm_max_f32(&AC_1000[0], 1000, &max_AC, &indexmax_AC);
        arm_min_f32(&AC_1000[0], 1000, &min_AC, &indexmin_AC);
        AC_valeur = max_AC - min_AC;
        return AC_valeur;

}
float32 DC;
float32 moyenne_DC;

float32 DC_sum(float32 signal[]){
     DC=0;
     moyenne_DC = 0;

        for(int i=0; i<1000; i++){
            DC += signal[i];
        }
        moyenne_DC = DC/1000;
        return moyenne_DC;
}


    float32_t signal_AC_R[1000];
    float32_t signal_2_75_R[1000];
    float32_t signal_AC_IF[1000];
    float32_t signal_2_75_IF[1000];
    float32_t signal_DC_R[1000];
    float32_t signal_DC_IF[1000];
    float32 AC_R;
    float32 AC_IF;
    float32 DC_R;
    float32 DC_IF;
    float32 S;
    float32 R;
    
void SPO2_task(void* pvParameters){
    
    (void)pvParameters;
    R = 0 ;
    S = 0;
    DC_R = 0;
    DC_IF = 0;
    AC_R = 0;
    DC_IF = 0;
   // Appeller fonction Filtres, AC et DC 
     filtre_2_75(red_data, signal_2_75_R);
     filtre_2_75(ir_data, signal_2_75_IF);

    DC_R = DC_sum(signal_2_75_R);
    DC_IF = DC_sum(signal_2_75_IF);
    
    for(int i=0; i<1000; i++){
        signal_AC_R[i] = signal_2_75_R[i] - DC_R;
        signal_AC_IF[i] = signal_2_75_IF[i] - DC_IF;
    }
    
    AC_R = AC(signal_AC_R);
    AC_IF = AC(signal_AC_IF);
    
    R = (AC_R/DC_R)/(AC_IF/DC_IF);
    S = -27.35*R +115.41;
 
}

 float32 max[50]={};
 float32 indice[50]={};
 float32_t signal_BPM[1000];
 float32 periode;
 float32 BPM;

void heart_rate_task(void* pvParameters){
    
    (void)pvParameters;
    BPM = 0;
    periode = 0;
    int j= 0;
   
    filtre_2_75(red_data, signal_BPM);
   
    for (int i=0; i<1000; i++){
        if(signal_BPM[i]> signal_BPM[i-1] && signal_BPM[i]> signal_BPM[i+1]){
            max[j] = signal_BPM[i];
            indice[j] = i;
            j++;
        } 
         if(j==3){
                break;
            }
            else{
           continue;
           }
    }
         
     periode = (indice[2]-indice[0])/200;

     BPM = 60/periode;

}
/* [] END OF FILE */
